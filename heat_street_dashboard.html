<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Heat Street Dashboard &mdash; London's Edwardian Terraced Housing</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-card: linear-gradient(135deg, rgba(30, 41, 59, 0.8), rgba(15, 23, 42, 0.9));
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --border-color: rgba(148, 163, 184, 0.1);
            --accent-blue: #3b82f6;
            --accent-green: #22c55e;
            --accent-orange: #f97316;
            --accent-purple: #a855f7;
            --accent-red: #ef4444;
        }

        body {
            font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(180deg, var(--bg-primary) 0%, var(--bg-secondary) 50%, var(--bg-primary) 100%);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.5;
        }

        /* Header */
        .header {
            background: linear-gradient(90deg, rgba(59, 130, 246, 0.1), rgba(139, 92, 246, 0.1));
            border-bottom: 1px solid var(--border-color);
            padding: 32px 48px;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo {
            background: linear-gradient(135deg, #f97316, #ef4444);
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .header h1 {
            font-size: 36px;
            font-weight: 700;
            background: linear-gradient(135deg, #f8fafc, #94a3b8);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -0.5px;
        }

        .header-subtitle {
            color: var(--text-secondary);
            font-size: 16px;
            margin-top: 4px;
        }

        .header-right {
            text-align: right;
        }

        .header-right .label {
            color: var(--text-muted);
            font-size: 13px;
        }

        .header-right .value {
            color: var(--text-primary);
            font-size: 16px;
            font-weight: 600;
        }

        /* Navigation */
        .nav {
            background: rgba(15, 23, 42, 0.7);
            border-bottom: 1px solid var(--border-color);
            padding: 16px 48px;
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(12px);
        }

        .nav-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            gap: 12px;
        }

        .nav-btn {
            background: rgba(30, 41, 59, 0.6);
            color: var(--text-secondary);
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 8px;
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: inherit;
        }

        .nav-btn:hover {
            background: rgba(59, 130, 246, 0.2);
            border-color: var(--accent-blue);
        }

        .nav-btn.active {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            border: none;
        }

        /* Main Content */
        .main {
            max-width: 1400px;
            margin: 0 auto;
            padding: 32px 48px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Cards */
        .card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 24px;
            border: 1px solid var(--border-color);
            margin-bottom: 24px;
        }

        .card-header {
            margin-bottom: 20px;
        }

        .card-title {
            color: var(--text-primary);
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .card-subtitle {
            color: var(--text-muted);
            font-size: 14px;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 32px;
        }

        @media (max-width: 1024px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 600px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            .header, .nav, .main {
                padding-left: 20px;
                padding-right: 20px;
            }
        }

        .stat-card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 24px;
            border: 1px solid var(--border-color);
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: -20px;
            right: -20px;
            width: 100px;
            height: 100px;
            background: radial-gradient(circle, var(--glow-color, rgba(59, 130, 246, 0.2)), transparent 70%);
            border-radius: 50%;
        }

        .stat-card.blue::before { --glow-color: rgba(59, 130, 246, 0.2); }
        .stat-card.orange::before { --glow-color: rgba(249, 115, 22, 0.2); }
        .stat-card.green::before { --glow-color: rgba(34, 197, 94, 0.2); }
        .stat-card.purple::before { --glow-color: rgba(168, 85, 247, 0.2); }

        .stat-label {
            color: var(--text-secondary);
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .stat-value {
            color: var(--text-primary);
            font-size: 32px;
            font-weight: 700;
            line-height: 1.1;
        }

        .stat-subvalue {
            color: var(--text-muted);
            font-size: 13px;
            margin-top: 8px;
        }

        /* Grid Layouts */
        .grid-2 {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 24px;
        }

        .grid-2-equal {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
        }

        @media (max-width: 900px) {
            .grid-2, .grid-2-equal {
                grid-template-columns: 1fr;
            }
        }

        /* Insights List */
        .insights-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .insight-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: rgba(15, 23, 42, 0.5);
            border-radius: 10px;
            border-left: 3px solid var(--accent-color);
        }

        .insight-item.blue { --accent-color: var(--accent-blue); }
        .insight-item.orange { --accent-color: var(--accent-orange); }
        .insight-item.green { --accent-color: var(--accent-green); }
        .insight-item.purple { --accent-color: var(--accent-purple); }

        .insight-label {
            color: var(--text-primary);
            font-weight: 600;
            font-size: 14px;
        }

        .insight-desc {
            color: var(--text-muted);
            font-size: 12px;
        }

        .insight-value {
            font-size: 20px;
            font-weight: 700;
            color: var(--accent-color);
        }

        /* Chart Container */
        .chart-container {
            position: relative;
            height: 280px;
            width: 100%;
        }

        .chart-container-lg {
            height: 320px;
        }

        /* HP Readiness Tiers */
        .tiers-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }

        @media (max-width: 1100px) {
            .tiers-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 700px) {
            .tiers-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .tier-card {
            background: linear-gradient(135deg, var(--tier-color-light), var(--tier-color-dark));
            border-radius: 12px;
            padding: 20px;
            border: 1px solid var(--tier-border);
        }

        .tier-card.t1 { --tier-color-light: rgba(34, 197, 94, 0.15); --tier-color-dark: rgba(34, 197, 94, 0.05); --tier-border: rgba(34, 197, 94, 0.4); --tier-accent: #22c55e; }
        .tier-card.t2 { --tier-color-light: rgba(132, 204, 22, 0.15); --tier-color-dark: rgba(132, 204, 22, 0.05); --tier-border: rgba(132, 204, 22, 0.4); --tier-accent: #84cc16; }
        .tier-card.t3 { --tier-color-light: rgba(249, 115, 22, 0.15); --tier-color-dark: rgba(249, 115, 22, 0.05); --tier-border: rgba(249, 115, 22, 0.4); --tier-accent: #f97316; }
        .tier-card.t4 { --tier-color-light: rgba(239, 68, 68, 0.15); --tier-color-dark: rgba(239, 68, 68, 0.05); --tier-border: rgba(239, 68, 68, 0.4); --tier-accent: #ef4444; }
        .tier-card.t5 { --tier-color-light: rgba(124, 45, 18, 0.15); --tier-color-dark: rgba(124, 45, 18, 0.05); --tier-border: rgba(124, 45, 18, 0.4); --tier-accent: #9a3412; }

        .tier-label {
            color: var(--tier-accent);
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 12px;
        }

        .tier-value {
            color: var(--text-primary);
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .tier-count {
            color: var(--text-secondary);
            font-size: 12px;
            margin-bottom: 12px;
        }

        .tier-cost {
            border-top: 1px solid var(--tier-border);
            padding-top: 12px;
        }

        .tier-cost-label {
            color: var(--text-muted);
            font-size: 11px;
        }

        .tier-cost-value {
            color: var(--text-primary);
            font-size: 14px;
            font-weight: 600;
        }

        /* Tables */
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th {
            text-align: left;
            padding: 12px 16px;
            color: var(--text-secondary);
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid rgba(148, 163, 184, 0.2);
            font-weight: 500;
        }

        .data-table td {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-secondary);
        }

        .data-table td:first-child {
            color: var(--text-primary);
            font-weight: 500;
        }

        .data-table tr.selected {
            background: rgba(59, 130, 246, 0.1);
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .badge.green {
            background: rgba(34, 197, 94, 0.2);
            color: var(--accent-green);
        }

        .badge.blue {
            background: rgba(59, 130, 246, 0.2);
            color: var(--accent-blue);
        }

        /* Scenario Selector */
        .scenario-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-top: 16px;
        }

        .scenario-btn {
            background: rgba(15, 23, 42, 0.6);
            color: var(--text-secondary);
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 10px;
            padding: 12px 20px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: inherit;
        }

        .scenario-btn:hover {
            background: rgba(59, 130, 246, 0.15);
            border-color: var(--accent-blue);
        }

        .scenario-btn.active {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            border: none;
        }

        /* Subsidy Selector */
        .subsidy-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-top: 16px;
        }

        .subsidy-btn {
            background: rgba(15, 23, 42, 0.6);
            color: var(--text-secondary);
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 10px;
            padding: 12px 20px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: inherit;
        }

        .subsidy-btn:hover {
            background: rgba(59, 130, 246, 0.15);
            border-color: var(--accent-blue);
        }

        .subsidy-btn.active {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            border: none;
        }

        /* Scenario Metrics */
        .scenario-metrics {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 32px;
        }

        @media (max-width: 900px) {
            .scenario-metrics {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .metric-card {
            border-radius: 12px;
            padding: 20px;
            border-left: 3px solid var(--metric-color);
        }

        .metric-card.blue { background: rgba(59, 130, 246, 0.1); --metric-color: var(--accent-blue); }
        .metric-card.green { background: rgba(34, 197, 94, 0.1); --metric-color: var(--accent-green); }
        .metric-card.orange { background: rgba(249, 115, 22, 0.1); --metric-color: var(--accent-orange); }
        .metric-card.purple { background: rgba(168, 85, 247, 0.1); --metric-color: var(--accent-purple); }

        .metric-label {
            color: var(--text-muted);
            font-size: 12px;
            margin-bottom: 8px;
        }

        .metric-value {
            color: var(--text-primary);
            font-size: 24px;
            font-weight: 700;
        }

        .metric-sub {
            color: var(--metric-color);
            font-size: 14px;
            margin-top: 4px;
        }

        /* EPC Progress */
        .epc-progress {
            background: rgba(15, 23, 42, 0.5);
            border-radius: 12px;
            padding: 20px;
        }

        .epc-progress-title {
            color: var(--text-secondary);
            font-size: 14px;
            margin-bottom: 16px;
        }

        .epc-comparison {
            display: flex;
            align-items: center;
            gap: 24px;
        }

        .epc-bar-container {
            flex: 1;
        }

        .epc-bar-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .epc-bar-label {
            color: var(--text-muted);
            font-size: 13px;
        }

        .epc-bar-value {
            color: var(--text-primary);
            font-weight: 600;
        }

        .epc-bar {
            height: 8px;
            background: rgba(148, 163, 184, 0.2);
            border-radius: 4px;
            overflow: hidden;
        }

        .epc-bar-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .epc-bar-fill.before {
            background: var(--accent-red);
        }

        .epc-bar-fill.after {
            background: var(--accent-green);
        }

        .epc-arrow {
            color: var(--accent-green);
            font-size: 24px;
            padding: 0 12px;
        }

        /* Glazing Grid */
        .glazing-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
        }

        @media (max-width: 800px) {
            .glazing-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .glazing-card {
            background: rgba(15, 23, 42, 0.5);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }

        .glazing-label {
            color: var(--text-muted);
            font-size: 13px;
            margin-bottom: 8px;
        }

        .glazing-value {
            color: var(--text-primary);
            font-size: 28px;
            font-weight: 700;
        }

        .glazing-count {
            color: var(--text-secondary);
            font-size: 12px;
            margin-top: 4px;
        }

        /* Footer */
        .footer {
            border-top: 1px solid var(--border-color);
            padding: 24px 48px;
            margin-top: 32px;
        }

        .footer-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: var(--text-muted);
            font-size: 13px;
        }

        @media (max-width: 700px) {
            .footer-content {
                flex-direction: column;
                gap: 8px;
                text-align: center;
            }
        }

        /* Color utilities */
        .text-green { color: var(--accent-green) !important; }
        .text-orange { color: var(--accent-orange) !important; }
        .text-blue { color: var(--accent-blue) !important; }
        .text-purple { color: var(--accent-purple) !important; }

        /* Data load banner */
        .data-status {
            max-width: 1400px;
            margin: 0 auto 16px;
            padding: 12px 16px;
            border: 1px solid var(--border-color);
            border-radius: 14px;
            background: rgba(15, 23, 42, 0.6);
            display: flex;
            gap: 12px;
            align-items: center;
            justify-content: space-between;
        }

        .data-status.error {
            border-color: rgba(239, 68, 68, 0.35);
            background: rgba(239, 68, 68, 0.08);
        }

        .data-status .message {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .data-status .actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .btn {
            appearance: none;
            border: 1px solid rgba(148, 163, 184, 0.18);
            background: rgba(30, 41, 59, 0.7);
            color: var(--text-primary);
            padding: 10px 12px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
        }

        .btn:hover { background: rgba(30, 41, 59, 0.9); }

        .narrative {
            color: var(--text-secondary);
            font-size: 14px;
            line-height: 1.7;
        }

        .narrative p + p { margin-top: 10px; }
        .narrative strong { color: var(--text-primary); font-weight: 700; }
        .narrative a { color: var(--accent-blue); text-decoration: none; }
        .narrative a:hover { text-decoration: underline; }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div>
                <div class="header-left">
                    <div class="logo">üè†</div>
                    <h1>Heat Street</h1>
                </div>
                <p class="header-subtitle">Low-Carbon Heating Potential for London's Edwardian Terraced Housing</p>
            </div>
            <div class="header-right">
                <p class="label">Analysis Date</p>
                <p class="value" id="analysisDate">‚Äî</p>
                <p class="label" style="margin-top: 10px;">Data Source</p>
                <p class="value" id="dataSource">‚Äî</p>
            </div>
        </div>
    </header>

    <!-- Navigation -->
    <nav class="nav">
        <div class="nav-content">
            <button class="nav-btn active" data-tab="overview">Overview</button>
            <button class="nav-btn" data-tab="stock">Housing Stock</button>
            <button class="nav-btn" data-tab="readiness">Retrofit Readiness</button>
            <button class="nav-btn" data-tab="scenarios">Scenario Comparison</button>
            <button class="nav-btn" data-tab="subsidy">Subsidy Sensitivity</button>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main">
        <div id="dataLoadStatus" class="data-status" style="display:none;">
            <div class="message" id="dataLoadMessage"></div>
            <div class="actions">
                <button class="btn" id="loadJsonBtn" type="button">Load JSON</button>
            </div>
        </div>
        <!-- Overview Tab -->
        <div id="overview" class="tab-content active">
            <div class="stats-grid">
                <div class="stat-card blue">
                    <p class="stat-label">Properties Analysed</p>
                    <p class="stat-value" id="kpiProperties">‚Äî</p>
                    <p class="stat-subvalue">Edwardian terraced homes</p>
                </div>
                <div class="stat-card orange">
                    <p class="stat-label">Gas Boiler Reliance</p>
                    <p class="stat-value" id="kpiGasPct">‚Äî</p>
                    <p class="stat-subvalue">of properties use gas</p>
                </div>
                <div class="stat-card green">
                    <p class="stat-label">HP Ready or Near-Ready</p>
                    <p class="stat-value" id="kpiHpReadyPct">‚Äî</p>
                    <p class="stat-subvalue">Tiers 1-2 combined</p>
                </div>
                <div class="stat-card purple">
                    <p class="stat-label">Mean SAP Score</p>
                    <p class="stat-value" id="kpiSapMean">‚Äî</p>
                    <p class="stat-subvalue">Mid-Band D average</p>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">How to read this dashboard</h2>
                    <p class="card-subtitle">A guided narrative for a policy audience</p>
                </div>
                <div class="narrative">
                    <p>
                        This dashboard summarises the Heat Street case study for London&rsquo;s Edwardian terraced housing.
                        It is generated from the latest one-stop pipeline output and is intended to support policy and programme
                        design discussions. It is a screening-level analysis: it supports stock-level comparisons, but it does
                        <strong>not</strong> replace detailed surveys, design work, or network feasibility studies for individual streets.
                    </p>
                    <p>
                        The story runs left-to-right across the tabs. We start with what the EPC Register records about the stock
                        (energy ratings, heating systems, and key fabric indicators). We then translate these signals into <strong>readiness tiers</strong>
                        for heat pumps and a separate set of <strong>heat network suitability tiers</strong> derived from spatial context. Finally, we compare
                        pathway scenarios (fabric-only, heat pumps, heat networks, and a Hybrid allocation) using a consistent set of published
                        cost and performance assumptions to estimate indicative investment, bill impacts and CO&#8322; outcomes.
                    </p>
                    <p>
                        Two interpretation notes: (1) EPCs are an administrative dataset and some fields are missing or recorded as
                        &ldquo;unknown&rdquo; for a material share of properties; and (2) the analysis is designed for <em>comparisons</em> under a common
                        baseline, so absolute totals should be read as indicative and sense-checked against local delivery intelligence.
                    </p>
                </div>
            </div>

            <div class="grid-2">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">EPC Band Distribution</h2>
                        <p class="card-subtitle">Current energy performance across the stock</p>
                    </div>
                    <div class="chart-container">
                        <canvas id="epcChart"></canvas>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Key Insights</h2>
                    </div>
                    <div class="insights-list">
                        <div class="insight-item orange">
                            <div>
                                <p class="insight-label">Below EPC C</p>
                                <p class="insight-desc">Require improvement</p>
                            </div>
                            <p class="insight-value text-orange" id="insightBelowEpcC">‚Äî</p>
                        </div>
                        <div class="insight-item blue">
                            <div>
                                <p class="insight-label">Wall Insulation</p>
                                <p class="insight-desc">Currently insulated</p>
                            </div>
                            <p class="insight-value text-blue" id="insightWallInsulation">‚Äî</p>
                        </div>
                        <div class="insight-item green">
                            <div>
                                <p class="insight-label">Double Glazing</p>
                                <p class="insight-desc">Already installed</p>
                            </div>
                            <p class="insight-value text-green" id="insightDoubleGlazing">‚Äî</p>
                        </div>
                        <div class="insight-item purple">
                            <div>
                                <p class="insight-label">Heat Pumps</p>
                                <p class="insight-desc">Current penetration</p>
                            </div>
                            <p class="insight-value text-purple" id="insightHeatPumps">‚Äî</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Decarbonisation Pathways at a Glance</h2>
                    <p class="card-subtitle">Comparing capital costs and CO‚ÇÇ outcomes across scenarios</p>
                </div>
                <div class="narrative">
                    <p>
                        This chart provides a high-level comparison of pathways on two axes: <strong>capital cost per property</strong> and
                        <strong>annual CO&#8322; reduction</strong>. It is a useful starting point for policy conversations about scale and ambition,
                        but it does not capture deliverability constraints (supply chain, disruption, planning) or wider system costs
                        (e.g., heat network backbone investment).
                    </p>
                </div>
                <div class="chart-container chart-container-lg">
                    <canvas id="scenarioOverviewChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Housing Stock Tab -->
        <div id="stock" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Housing stock context</h2>
                    <p class="card-subtitle">What these distributions tell us (and why they matter)</p>
                </div>
                <div class="narrative">
                    <p>
                        This tab summarises the physical characteristics that shape low-carbon heating choices.
                        Wall construction affects insulation feasibility and cost; the current heating system shows
                        today&rsquo;s fuel reliance; and glazing/loft indicators help explain baseline heat demand and the
                        practical scale of fabric upgrades.
                    </p>
                    <p>
                        The lodgements chart below adds a time dimension. It shows how the mix of EPC ratings for newly
                        lodged certificates has shifted year-by-year. The y-axis is the count of lodgements; each bar segment
                        is labelled with its within-year percentage so the chart highlights the growth in higher-rated (A&ndash;C)
                        lodgements even when total volumes change.
                    </p>
                    <p>
                        Data note: where EPC fields are missing or ambiguous, we retain an &ldquo;Unknown&rdquo; category rather than
                        imputing values. This keeps the charts transparent about data coverage, but it also means that shares can reflect
                        both real stock characteristics and recording completeness.
                    </p>
                </div>
            </div>

            <div class="grid-2-equal">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Wall Construction Types</h2>
                        <p class="card-subtitle">Distribution across the housing stock</p>
                    </div>
                    <div class="chart-container">
                        <canvas id="wallChart"></canvas>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Heating Systems</h2>
                        <p class="card-subtitle">Current heating technology mix</p>
                    </div>
                    <div class="chart-container">
                        <canvas id="heatingChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">EPC lodgements over time</h2>
                    <p class="card-subtitle">Counts by year, stacked by EPC band (segment labels show % share)</p>
                </div>
                <div class="narrative">
                    <p>
                        This chart is useful for sense-checking whether newer certificates are skewing toward higher EPC bands.
                        If A&ndash;C segments grow as a share of annual lodgements, it suggests improving performance among properties
                        getting certified (for example through upgrades at sale/let, compliance activity, or targeted programmes).
                    </p>
                    <p>
                        Important caveat: lodgements are not a random sample of the entire stock. This is a trend in the
                        <em>certified</em> subset, so we interpret it alongside the stock-wide baseline shown elsewhere in the dashboard.
                    </p>
                </div>
                <div class="chart-container chart-container-lg" style="margin-top: 14px;">
                    <canvas id="lodgementYearBandChart"></canvas>
                </div>
                <div class="narrative" id="lodgementYearBandFallback" style="display:none; margin-top: 12px;"></div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Glazing Status</h2>
                    <p class="card-subtitle">Window types across the stock</p>
                </div>
                <div class="glazing-grid">
                    <div class="glazing-card">
                        <p class="glazing-label">Double Glazing</p>
                        <p class="glazing-value" id="glazingDoublePct">‚Äî</p>
                        <p class="glazing-count" id="glazingDoubleCount">‚Äî</p>
                    </div>
                    <div class="glazing-card">
                        <p class="glazing-label">Unknown</p>
                        <p class="glazing-value" id="glazingUnknownPct">‚Äî</p>
                        <p class="glazing-count" id="glazingUnknownCount">‚Äî</p>
                    </div>
                    <div class="glazing-card">
                        <p class="glazing-label">Single Glazing</p>
                        <p class="glazing-value" id="glazingSinglePct">‚Äî</p>
                        <p class="glazing-count" id="glazingSingleCount">‚Äî</p>
                    </div>
                    <div class="glazing-card">
                        <p class="glazing-label">Triple Glazing</p>
                        <p class="glazing-value" id="glazingTriplePct">‚Äî</p>
                        <p class="glazing-count" id="glazingTripleCount">‚Äî</p>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Loft Insulation Status</h2>
                    <p class="card-subtitle">Roof insulation levels</p>
                </div>
                <div class="chart-container chart-container-lg">
                    <canvas id="loftChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Retrofit Readiness Tab -->
        <div id="readiness" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Retrofit readiness logic</h2>
                    <p class="card-subtitle">How tiering supports pathway decisions</p>
                </div>
                <div class="narrative">
                    <p>
                        Readiness tiers translate EPC signals into practical groups that help prioritise action.
                        Tier&nbsp;1 homes are modelled as ready for low-carbon heat with minimal prerequisite work; higher tiers
                        reflect increasing fabric requirements, system constraints, and cost barriers; Tier&nbsp;5 indicates homes
                        that are currently unlikely to be suitable for heat pumps under the study assumptions.
                    </p>
                    <p>
                        Heat network tiers provide the complementary picture: where district heat is more plausible because of local
                        heat-demand density and proximity to existing (and planned) network areas. These tiers are used in the Hybrid
                        scenario to guide whether homes are allocated to a heat network pathway or a heat pump pathway.
                    </p>
                    <p>
                        Practical caveat: both tiering systems are screening tools built from available data. They do not capture every
                        constraint that matters on the ground (e.g., outdoor unit space, internal distribution upgrades, electrical capacity,
                        resident preferences, heritage constraints, or network deliverability). We treat them as a way to structure prioritisation
                        and scenario design, not as a definitive classification for individual properties.
                    </p>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Heat Pump Readiness Tiers</h2>
                    <p class="card-subtitle">Classification by retrofit complexity and cost</p>
                </div>

                <div class="tiers-grid">
                    <div class="tier-card t1">
                        <p class="tier-label">Tier 1: Ready Now</p>
                        <p class="tier-value" id="hpTier1Pct">‚Äî</p>
                        <p class="tier-count" id="hpTier1Count">‚Äî</p>
                    </div>
                    <div class="tier-card t2">
                        <p class="tier-label">Tier 2: Minor Work</p>
                        <p class="tier-value" id="hpTier2Pct">‚Äî</p>
                        <p class="tier-count" id="hpTier2Count">‚Äî</p>
                    </div>
                    <div class="tier-card t3">
                        <p class="tier-label">Tier 3: Major Work</p>
                        <p class="tier-value" id="hpTier3Pct">‚Äî</p>
                        <p class="tier-count" id="hpTier3Count">‚Äî</p>
                    </div>
                    <div class="tier-card t4">
                        <p class="tier-label">Tier 4: Challenging</p>
                        <p class="tier-value" id="hpTier4Pct">‚Äî</p>
                        <p class="tier-count" id="hpTier4Count">‚Äî</p>
                    </div>
                    <div class="tier-card t5">
                        <p class="tier-label">Tier 5: Not Suitable</p>
                        <p class="tier-value" id="hpTier5Pct">‚Äî</p>
                        <p class="tier-count" id="hpTier5Count">‚Äî</p>
                    </div>
                </div>

                <div class="chart-container">
                    <canvas id="readinessChart"></canvas>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Heat Network Suitability Tiers</h2>
                    <p class="card-subtitle">Based on demand density and proximity to existing/planned networks</p>
                </div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Tier</th>
                            <th>Properties</th>
                            <th>Share</th>
                            <th>Recommended Pathway</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td colspan="4" style="color: var(--text-muted);">Loading‚Ä¶</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Scenario Comparison Tab -->
        <div id="scenarios" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Scenario logic (plain language)</h2>
                    <p class="card-subtitle">What changes between pathways and how to interpret the metrics</p>
                </div>
                <div class="narrative">
                    <p>
                        Scenarios compare alternative decarbonisation pathways using a common baseline for the same housing stock.
                        The model applies consistent, published cost and performance assumptions to estimate indicative outcomes:
                        capital investment, annual bill impacts, and annual CO&#8322; reductions at the stock level.
                    </p>
                    <p>
                        Fabric scenarios apply sequential upgrade measures (e.g., loft, draught-proofing, insulation, glazing). The
                        &ldquo;Fabric Tipping&rdquo; option stops when additional measures deliver sharply lower energy savings per pound
                        invested. Heat pump and heat network scenarios then layer in low-carbon heating routes; the Hybrid pathway uses
                        readiness and heat network suitability tiers to allocate homes to the most plausible option under the study assumptions.
                    </p>
                    <p>
                        Metric note: &ldquo;Simple payback&rdquo; is shown as an intuitive ratio of capital cost to annual bill savings under
                        the modeled tariffs and performance assumptions. It is not a discounted cashflow appraisal, and it does not include
                        co-benefits (comfort, health), distributional impacts, or broader system costs. Policy decisions should interpret payback
                        alongside strategic objectives, affordability and deliverability.
                    </p>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Select Scenario</h2>
                    <p class="card-subtitle">Compare different decarbonisation pathways</p>
                </div>
                <div class="scenario-selector">
                    <button class="scenario-btn" data-scenario="fabric_only">Fabric Only</button>
                    <button class="scenario-btn" data-scenario="fabric_to_tipping_point">Fabric Tipping</button>
                    <button class="scenario-btn" data-scenario="minimum_fabric_hp_ready">Min Fabric+HP</button>
                    <button class="scenario-btn" data-scenario="heat_pump">Heat Pump</button>
                    <button class="scenario-btn" data-scenario="heat_network">Heat Network</button>
                    <button class="scenario-btn active" data-scenario="hybrid">Hybrid</button>
                </div>
            </div>

            <div class="card" id="scenarioDetails">
                <div class="card-header">
                    <h2 class="card-title" id="scenarioTitle">Hybrid (HP + HN)</h2>
                    <p class="card-subtitle">Detailed scenario metrics</p>
                </div>

                <div class="scenario-metrics">
                    <div class="metric-card blue">
                        <p class="metric-label">Total Capital Cost</p>
                        <p class="metric-value" id="metricCapital">‚Äî</p>
                        <p class="metric-sub" id="metricCapitalPer">‚Äî</p>
                    </div>
                    <div class="metric-card green">
                        <p class="metric-label">Annual CO‚ÇÇ Reduction</p>
                        <p class="metric-value" id="metricCO2">‚Äî</p>
                        <p class="metric-sub">per year</p>
                    </div>
                    <div class="metric-card orange">
                        <p class="metric-label">Annual Bill Savings</p>
                        <p class="metric-value" id="metricBills">‚Äî</p>
                        <p class="metric-sub">per year</p>
                    </div>
                    <div class="metric-card purple">
                        <p class="metric-label">Simple Payback</p>
                        <p class="metric-value" id="metricPayback">‚Äî</p>
                        <p class="metric-sub">average</p>
                    </div>
                </div>

                <div class="epc-progress">
                    <p class="epc-progress-title">EPC Band C+ Improvement</p>
                    <div class="epc-comparison">
                        <div class="epc-bar-container">
                            <div class="epc-bar-header">
                                <span class="epc-bar-label">Before</span>
                                <span class="epc-bar-value" id="epcBefore">‚Äî</span>
                            </div>
                            <div class="epc-bar">
                                <div class="epc-bar-fill before" id="epcBarBefore" style="width: 0%"></div>
                            </div>
                        </div>
                        <span class="epc-arrow">‚Üí</span>
                        <div class="epc-bar-container">
                            <div class="epc-bar-header">
                                <span class="epc-bar-label">After</span>
                                <span class="epc-bar-value" id="epcAfter">‚Äî</span>
                            </div>
                            <div class="epc-bar">
                                <div class="epc-bar-fill after" id="epcBarAfter" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Fabric investment tipping point</h2>
                    <p class="card-subtitle">Diminishing returns from sequential retrofit measures</p>
                </div>
                <div class="narrative">
                    <p>
                        The bars show the <strong>marginal efficiency</strong> of each additional fabric measure: how many kWh of annual heat-demand
                        reduction are delivered per &pound;1,000 invested (higher is better). The line shows <strong>cumulative</strong> investment as measures
                        are added sequentially.
                    </p>
                    <p>
                        This is a practical way to explain why some measures are prioritised early (high savings per pound) and why later measures can
                        be harder to justify on cost-effectiveness alone (lower marginal returns), even if they still contribute to deeper demand reduction.
                    </p>
                </div>
                <div class="chart-container chart-container-lg" style="margin-top: 14px;">
                    <canvas id="tippingPointChart"></canvas>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Full Scenario Comparison</h2>
                </div>
                <table class="data-table" id="scenarioTable">
                    <thead>
                        <tr>
                            <th>Scenario</th>
                            <th>Capital Cost</th>
                            <th>¬£/Property</th>
                            <th>CO‚ÇÇ Saved</th>
                            <th>Bill Savings</th>
                            <th>Payback</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td colspan="6" style="color: var(--text-muted);">Loading‚Ä¶</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Subsidy Sensitivity Tab -->
        <div id="subsidy" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Subsidy sensitivity (policy lever)</h2>
                    <p class="card-subtitle">How capital subsidies can change payback, uptake and public spend under consistent assumptions</p>
                </div>
                <div class="narrative">
                    <p>
                        This module tests a set of subsidy levels (0&ndash;100%) applied to the scenario&rsquo;s modeled capital cost.
                        Lower up-front costs improve simple payback; we then translate payback into an <strong>illustrative uptake rate</strong>
                        using a smooth adoption curve (a logistic function). This is designed for sensitivity testing &mdash; not as a forecast of
                        what will happen without complementary policy (delivery capacity, consumer confidence, installer supply, planning and
                        infrastructure constraints).
                    </p>
                    <p>
                        The charts below show how subsidy can shift: (i) the private up-front cost per property, (ii) the implied payback,
                        (iii) the modeled uptake rate and upgraded property count, and (iv) total public expenditure and carbon abatement cost.
                        All results are for this case-study stock and the assumptions used elsewhere in the pipeline.
                    </p>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Select pathway</h2>
                    <p class="card-subtitle">Choose which scenario receives the subsidy</p>
                </div>
                <div class="subsidy-selector" id="subsidyScenarioButtons"></div>
                <div class="narrative" id="subsidyFallback" style="display:none; margin-top: 12px;"></div>
            </div>

            <div class="grid-2-equal">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Up-front cost after subsidy</h2>
                        <p class="card-subtitle">Capital cost per upgraded property (after subsidy)</p>
                    </div>
                    <div class="chart-container">
                        <canvas id="subsidyNetCostChart"></canvas>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Simple payback (stock-average)</h2>
                        <p class="card-subtitle">Capital cost divided by annual bill savings under the scenario</p>
                    </div>
                    <div class="chart-container">
                        <canvas id="subsidyPaybackChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="grid-2-equal">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Modeled uptake rate</h2>
                        <p class="card-subtitle">Illustrative adoption response to payback (logistic curve)</p>
                    </div>
                    <div class="chart-container">
                        <canvas id="subsidyUptakeChart"></canvas>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Properties upgraded</h2>
                        <p class="card-subtitle">Upgraded properties = total properties &times; modeled uptake rate</p>
                    </div>
                    <div class="chart-container">
                        <canvas id="subsidyPropertiesChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="grid-2-equal">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Public expenditure</h2>
                        <p class="card-subtitle">Total public cost of the subsidy across upgraded properties</p>
                    </div>
                    <div class="chart-container">
                        <canvas id="subsidySpendChart"></canvas>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Carbon abatement cost</h2>
                        <p class="card-subtitle">Public &pound; per tonne CO&#8322; saved (over the analysis horizon)</p>
                    </div>
                    <div class="chart-container">
                        <canvas id="subsidyCarbonChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Subsidy sensitivity table</h2>
                    <p class="card-subtitle">Full results for the selected pathway (from one-stop JSON)</p>
                </div>
                <table class="data-table" id="subsidyTable">
                    <thead>
                        <tr>
                            <th>Subsidy</th>
                            <th>Cost/property (after)</th>
                            <th>Payback</th>
                            <th>Uptake</th>
                            <th>Upgraded</th>
                            <th>Public spend</th>
                            <th>&pound;/tCO&#8322;</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td colspan="7" style="color: var(--text-muted);">Loading√¢‚Ç¨¬¶</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-content">
            <p>Heat Street Project ‚Ä¢ Danish Energy Agency ‚Ä¢ Danish Embassy ‚Ä¢ ADE Research</p>
            <p>Data: UK EPC Register ‚Ä¢ <span id="footerPropertiesCount">‚Äî</span> properties analysed</p>
        </div>
    </footer>

    <script>
        // Scenario Data (overwritten after loading one_stop_output.json)
        let scenarioData = {
            fabric_only: {
                name: 'Fabric Improvements Only',
                capitalTotal: '¬£15.6bn',
                capitalPer: '¬£22,100/property',
                co2: '0.89 Mt',
                bills: '¬£381m',
                payback: '41 years',
                epcBefore: 32.3,
                epcAfter: 88.1
            },
            fabric_to_tipping_point: {
                name: 'Fabric to Tipping Point',
                capitalTotal: '¬£3.0bn',
                capitalPer: '¬£4,193/property',
                co2: '0.32 Mt',
                bills: '¬£141m',
                payback: '21 years',
                epcBefore: 32.3,
                epcAfter: 84.8
            },
            minimum_fabric_hp_ready: {
                name: 'Minimum Fabric + ASHP',
                capitalTotal: '¬£14.1bn',
                capitalPer: '¬£19,958/property',
                co2: '1.27 Mt',
                bills: '¬£362m',
                payback: '39 years',
                epcBefore: 32.3,
                epcAfter: 84.8
            },
            heat_pump: {
                name: 'Heat Pump (Full Deployment)',
                capitalTotal: '¬£18.7bn',
                capitalPer: '¬£26,394/property',
                co2: '1.37 Mt',
                bills: '¬£401m',
                payback: '47 years',
                epcBefore: 32.3,
                epcAfter: 84.8
            },
            heat_network: {
                name: 'Heat Network (Full Deployment)',
                capitalTotal: '¬£14.4bn',
                capitalPer: '¬£20,326/property',
                co2: '1.77 Mt',
                bills: '¬£197m',
                payback: '73 years',
                epcBefore: 32.3,
                epcAfter: 84.8
            },
            hybrid: {
                name: 'Hybrid (HP + HN)',
                capitalTotal: '¬£14.4bn',
                capitalPer: '¬£20,409/property',
                co2: '1.54 Mt',
                bills: '¬£276m',
                payback: '52 years',
                epcBefore: 32.3,
                epcAfter: 84.8
            }
        };

        const STATE = {
            oneStop: null,
            source: null,
            charts: {},
            subsidy: {
                byScenario: {},
                scenarioOrder: [],
                selectedScenario: null
            }
        };

        // Chart.js defaults
        Chart.defaults.color = '#94a3b8';
        Chart.defaults.borderColor = 'rgba(148, 163, 184, 0.1)';
        Chart.defaults.font.family = "'DM Sans', sans-serif";
        if (window.ChartDataLabels) {
            Chart.register(ChartDataLabels);
            Chart.defaults.plugins.datalabels = { display: false };
        }

        const tooltipStyle = {
            backgroundColor: 'rgba(15, 23, 42, 0.95)',
            titleColor: '#f8fafc',
            bodyColor: '#94a3b8',
            borderColor: 'rgba(148, 163, 184, 0.2)',
            borderWidth: 1,
            padding: 12,
            cornerRadius: 8
        };

        function setDataStatus({ message, error = false } = {}) {
            const wrapper = document.getElementById('dataLoadStatus');
            const msg = document.getElementById('dataLoadMessage');
            if (!message) {
                wrapper.style.display = 'none';
                wrapper.classList.remove('error');
                msg.textContent = '';
                return;
            }
            wrapper.style.display = 'flex';
            wrapper.classList.toggle('error', Boolean(error));
            msg.textContent = message;
        }

        function formatInt(v) {
            if (v === null || v === undefined || Number.isNaN(v)) return '‚Äî';
            return Math.round(Number(v)).toLocaleString();
        }

        function formatPercent(v, decimals = 1) {
            if (v === null || v === undefined || Number.isNaN(v)) return '‚Äî';
            return Number(v).toFixed(decimals) + '%';
        }

        function formatGbp(v, decimals = 0) {
            if (v === null || v === undefined || Number.isNaN(v)) return '‚Äî';
            return '¬£' + Number(v).toLocaleString(undefined, { maximumFractionDigits: decimals, minimumFractionDigits: decimals });
        }

        function formatGbpCompact(v) {
            if (v === null || v === undefined || Number.isNaN(v)) return '‚Äî';
            const n = Number(v);
            if (n >= 1e9) return '¬£' + (n / 1e9).toFixed(1) + 'bn';
            if (n >= 1e6) return '¬£' + Math.round(n / 1e6).toLocaleString() + 'm';
            return formatGbp(n, 0);
        }

        function formatMtFromKg(kg) {
            if (kg === null || kg === undefined || Number.isNaN(kg)) return '‚Äî';
            return (Number(kg) / 1e9).toFixed(2) + ' Mt';
        }

        function formatYears(y) {
            if (y === null || y === undefined || Number.isNaN(y)) return '‚Äî';
            return Math.round(Number(y)) + ' years';
        }

        function getDatapointMap(section) {
            const out = {};
            (section?.datapoints || []).forEach(dp => { out[dp.key] = dp.value; });
            return out;
        }

        async function tryFetchJson(path) {
            const res = await fetch(path, { cache: 'no-store' });
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            return await res.json();
        }

        async function loadOneStopData() {
            if (window.__HEATSTREET_ONE_STOP) {
                const d = window.__HEATSTREET_ONE_STOP;
                if (!d.__source) d.__source = 'embedded one_stop_output.json';
                return d;
            }
            const candidates = [
                'HeatStreet/data/outputs/one_stop_output.json',
                'data/outputs/one_stop_output.json',
                'one_stop_output.json'
            ];
            for (const path of candidates) {
                try {
                    const d = await tryFetchJson(path);
                    d.__source = path;
                    return d;
                } catch (_) {}
            }
            throw new Error('Unable to auto-load one_stop_output.json. If you opened this file directly, start a local web server (recommended) or use ‚ÄúLoad JSON‚Äù.');
        }

        function destroyCharts() {
            Object.values(STATE.charts).forEach(ch => { try { ch.destroy(); } catch (_) {} });
            STATE.charts = {};
        }

        function renderCharts(chartsData) {
            destroyCharts();

            const {
                epcCounts,
                scenarioLabels,
                scenarioCostK,
                scenarioCo2Mt,
                wallLabels,
                wallCounts,
                heatingLabels,
                heatingCounts,
                loftLabels,
                loftCounts,
                readinessCounts
            } = chartsData;

            // EPC Distribution Chart
            STATE.charts.epcChart = new Chart(document.getElementById('epcChart'), {
                type: 'bar',
                data: {
                    labels: ['A', 'B', 'C', 'D', 'E', 'F', 'G'],
                    datasets: [{
                        data: epcCounts,
                        backgroundColor: ['#1a5f2a', '#2d8f3e', '#5cb85c', '#f0ad4e', '#d9534f', '#a94442', '#7a2a2a'],
                        borderRadius: 6,
                        borderSkipped: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            ...tooltipStyle,
                            callbacks: {
                                label: ctx => ctx.raw.toLocaleString() + ' properties'
                            }
                        }
                    },
                    scales: {
                        y: {
                            ticks: { callback: v => (v / 1000) + 'k' },
                            grid: { color: 'rgba(148, 163, 184, 0.1)' }
                        },
                        x: { grid: { display: false } }
                    }
                }
            });

            // Scenario Overview Chart
            STATE.charts.scenarioOverviewChart = new Chart(document.getElementById('scenarioOverviewChart'), {
                type: 'bar',
                data: {
                    labels: scenarioLabels,
                    datasets: [
                        {
                            label: 'Capital Cost (¬£k/property)',
                            data: scenarioCostK,
                            backgroundColor: '#3b82f6',
                            borderRadius: 4,
                            yAxisID: 'y'
                        },
                        {
                            label: 'CO‚ÇÇ Reduction (Mt/yr)',
                            data: scenarioCo2Mt,
                            backgroundColor: '#22c55e',
                            borderRadius: 4,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: { padding: 20, usePointStyle: true, pointStyle: 'rectRounded' }
                        },
                        tooltip: tooltipStyle
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            position: 'left',
                            title: { display: true, text: '¬£k/property', color: '#3b82f6' },
                            grid: { color: 'rgba(148, 163, 184, 0.1)' }
                        },
                        y1: {
                            type: 'linear',
                            position: 'right',
                            title: { display: true, text: 'Mt CO‚ÇÇ/yr', color: '#22c55e' },
                            grid: { display: false }
                        },
                        x: { grid: { display: false } }
                    }
                }
            });

            // Wall Chart
            STATE.charts.wallChart = new Chart(document.getElementById('wallChart'), {
                type: 'doughnut',
                data: {
                    labels: wallLabels,
                    datasets: [{
                        data: wallCounts,
                        backgroundColor: ['#3b82f6', '#8b5cf6', '#06b6d4', '#f97316', '#ef4444', '#22c55e'],
                        borderWidth: 0,
                        hoverOffset: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '55%',
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: { padding: 16, usePointStyle: true, pointStyle: 'circle' }
                        },
                        tooltip: {
                            ...tooltipStyle,
                            callbacks: {
                                label: ctx => {
                                    const total = ctx.dataset.data.reduce((a, b) => a + b, 0);
                                    const pct = ((ctx.raw / total) * 100).toFixed(1);
                                    return ctx.label + ': ' + ctx.raw.toLocaleString() + ' (' + pct + '%)';
                                }
                            }
                        }
                    }
                }
            });

            // Heating Chart
            STATE.charts.heatingChart = new Chart(document.getElementById('heatingChart'), {
                type: 'bar',
                data: {
                    labels: heatingLabels,
                    datasets: [{
                        data: heatingCounts,
                        backgroundColor: ['#4a90d9', '#f5a623', '#9b9b9b', '#7ed321', '#50e3c2'],
                        borderRadius: 6
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            ...tooltipStyle,
                            callbacks: {
                                label: ctx => ctx.raw.toLocaleString() + ' properties'
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { callback: v => (v / 1000) + 'k' },
                            grid: { color: 'rgba(148, 163, 184, 0.1)' }
                        },
                        y: { grid: { display: false } }
                    }
                }
            });

            // Loft Chart
            STATE.charts.loftChart = new Chart(document.getElementById('loftChart'), {
                type: 'bar',
                data: {
                    labels: loftLabels,
                    datasets: [{
                        data: loftCounts,
                        backgroundColor: '#8b5cf6',
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            ...tooltipStyle,
                            callbacks: {
                                label: ctx => ctx.raw.toLocaleString() + ' properties'
                            }
                        }
                    },
                    scales: {
                        y: {
                            ticks: { callback: v => (v / 1000) + 'k' },
                            grid: { color: 'rgba(148, 163, 184, 0.1)' }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { maxRotation: 45, minRotation: 45 }
                        }
                    }
                }
            });

            // Readiness Chart
            STATE.charts.readinessChart = new Chart(document.getElementById('readinessChart'), {
                type: 'bar',
                data: {
                    labels: ['Tier 1: Ready Now', 'Tier 2: Minor Work', 'Tier 3: Major Work', 'Tier 4: Challenging', 'Tier 5: Not Suitable'],
                    datasets: [{
                        data: readinessCounts,
                        backgroundColor: ['#22c55e', '#84cc16', '#f97316', '#ef4444', '#7c2d12'],
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            ...tooltipStyle,
                            callbacks: {
                                label: ctx => ctx.raw.toLocaleString() + ' properties'
                            }
                        }
                    },
                    scales: {
                        y: {
                            ticks: { callback: v => (v / 1000) + 'k' },
                            grid: { color: 'rgba(148, 163, 184, 0.1)' }
                        },
                        x: { grid: { display: false } }
                    }
                }
            });
        }

        function renderTippingPointChart(oneStop) {
            const canvas = document.getElementById('tippingPointChart');
            if (!canvas) return;

            const rows = oneStop?.sections?.section_8?.tables?.[0]?.data || [];
            const steps = rows.filter(r => Number(r?.step || 0) > 0);
            if (!steps.length) return;

            const labels = steps.map(r => r.measure_name || r.measure_id || `Step ${r.step}`);
            const marginalCapex = steps.map(r => Number(r.marginal_capex || 0));
            const marginalKwh = steps.map(r => Number(r.marginal_kwh_saved || 0));
            const cumulativeCapex = steps.map(r => Number(r.cumulative_capex || 0));

            const efficiency = marginalCapex.map((capex, i) => {
                const kwh = marginalKwh[i];
                if (!capex || !kwh) return 0;
                return kwh / (capex / 1000);
            });

            const COST_EFFECTIVE = 2500;
            const MODERATE = 1000;
            const threshold = labels.map(() => COST_EFFECTIVE);

            const barColors = efficiency.map(v => (v > COST_EFFECTIVE ? '#22c55e' : (v >= MODERATE ? '#f97316' : '#ef4444')));

            STATE.charts.tippingPointChart = new Chart(canvas, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [
                        {
                            type: 'bar',
                            label: 'Marginal efficiency (kWh saved per ¬£1,000 invested)',
                            data: efficiency,
                            backgroundColor: barColors,
                            borderRadius: 6,
                            borderSkipped: false,
                            yAxisID: 'y'
                        },
                        {
                            type: 'line',
                            label: 'Cumulative investment (¬£)',
                            data: cumulativeCapex,
                            yAxisID: 'y1',
                            borderColor: '#a16207',
                            backgroundColor: 'rgba(161, 98, 7, 0.15)',
                            tension: 0.25,
                            pointRadius: 3,
                            pointHoverRadius: 5
                        },
                        {
                            type: 'line',
                            label: 'Cost-effective threshold (2,500 kWh/¬£1k)',
                            data: threshold,
                            yAxisID: 'y',
                            borderColor: '#3b82f6',
                            borderDash: [6, 6],
                            pointRadius: 0,
                            borderWidth: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        datalabels: { display: false },
                        legend: {
                            position: 'top',
                            labels: { padding: 18, usePointStyle: true, pointStyle: 'rectRounded' }
                        },
                        tooltip: {
                            ...tooltipStyle,
                            callbacks: {
                                label: (ctx) => {
                                    const i = ctx.dataIndex;
                                    if (ctx.dataset.type === 'bar') {
                                        const eff = efficiency[i] || 0;
                                        const cap = marginalCapex[i] || 0;
                                        const kwh = marginalKwh[i] || 0;
                                        return [
                                            `Marginal efficiency: ${Math.round(eff).toLocaleString()} kWh/¬£1k`,
                                            `Marginal capex: ¬£${Math.round(cap).toLocaleString()}`,
                                            `Marginal kWh saved: ${Math.round(kwh).toLocaleString()} kWh`
                                        ];
                                    }
                                    if (ctx.dataset.yAxisID === 'y1') {
                                        const cap = cumulativeCapex[i] || 0;
                                        return `Cumulative investment: ¬£${Math.round(cap).toLocaleString()}`;
                                    }
                                    return ctx.dataset.label + ': ' + ctx.raw;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: { display: false },
                            ticks: { maxRotation: 35, minRotation: 35 }
                        },
                        y: {
                            position: 'left',
                            title: { display: true, text: 'kWh saved per ¬£1,000 invested', color: '#94a3b8' },
                            grid: { color: 'rgba(148, 163, 184, 0.1)' },
                            ticks: { callback: v => Math.round(v).toLocaleString() }
                        },
                        y1: {
                            position: 'right',
                            title: { display: true, text: 'Cumulative investment (¬£)', color: '#94a3b8' },
                            grid: { display: false },
                            ticks: {
                                callback: v => {
                                    const n = Number(v) || 0;
                                    if (n >= 1000) return '¬£' + Math.round(n / 1000).toLocaleString() + 'k';
                                    return '¬£' + Math.round(n).toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }

        function renderLodgementYearBandChart(oneStop) {
            const canvas = document.getElementById('lodgementYearBandChart');
            const fallback = document.getElementById('lodgementYearBandFallback');
            if (!canvas || !fallback) return;

            fallback.style.display = 'none';
            fallback.innerHTML = '';
            canvas.style.display = 'block';

            try {
                const tables = oneStop?.sections?.section_3?.tables || [];
                const table = tables.find(t => (t.caption || '').toLowerCase().includes('lodgements by year'));
                const columns = table?.columns || [];
                const rows = table?.data || [];
                if (!columns.length || !rows.length) {
                    throw new Error('No lodgements-by-year table found in one-stop output.');
                }

                const yearKey = columns.find(c => String(c).toLowerCase() === 'year') || 'year';
                const bandKeys = columns.filter(c => c !== yearKey);
                const years = rows.map(r => Number(r[yearKey])).filter(v => Number.isFinite(v));

                const colorMap = {
                    'A': '#1a5f2a',
                    'B': '#2d8f3e',
                    'C': '#5cb85c',
                    'D': '#f0ad4e',
                    'E': '#f97316',
                    'F': '#ef4444',
                    'G': '#7c2d12',
                    'Unknown': '#9e9e9e'
                };

                const datasets = bandKeys.map(band => ({
                    label: band,
                    data: rows.map(r => Number(r[band] || 0)),
                    backgroundColor: colorMap[band] || '#64748b',
                    stack: 'lodgements',
                    borderWidth: 0
                }));

                const totals = years.map((_, idx) => datasets.reduce((sum, ds) => sum + (Number(ds.data[idx]) || 0), 0));
                const emphasise = new Set(['A', 'B', 'C', 'D']);

                STATE.charts.lodgementYearBandChart = new Chart(canvas, {
                    type: 'bar',
                    data: { labels: years, datasets },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: { padding: 18, usePointStyle: true, pointStyle: 'rectRounded' }
                            },
                            tooltip: {
                                ...tooltipStyle,
                                callbacks: {
                                    label: (ctx) => {
                                        const value = Number(ctx.raw || 0);
                                        const total = totals[ctx.dataIndex] || 0;
                                        const pct = total ? (value / total) * 100 : 0;
                                        const pctLabel = pct > 0 && pct < 1 ? '<1%' : `${pct.toFixed(0)}%`;
                                        return `${ctx.dataset.label}: ${value.toLocaleString()} (${pctLabel})`;
                                    }
                                }
                            },
                            datalabels: {
                                display: (ctx) => {
                                    const value = Number(ctx.raw || 0);
                                    if (!value) return false;
                                    const total = totals[ctx.dataIndex] || 0;
                                    if (!total) return false;
                                    const pct = (value / total) * 100;
                                    const band = ctx.dataset.label;
                                    if (!emphasise.has(band)) return false;
                                    if (pct >= 1) return true;
                                    return value >= 10;
                                },
                                formatter: (value, ctx) => {
                                    const total = totals[ctx.dataIndex] || 0;
                                    if (!total) return '';
                                    const pct = (Number(value || 0) / total) * 100;
                                    if (pct > 0 && pct < 1) return '<1%';
                                    return `${Math.round(pct)}%`;
                                },
                                color: (ctx) => (ctx.dataset.label === 'A' || ctx.dataset.label === 'B' ? '#ffffff' : '#0f172a'),
                                font: { weight: '700', size: 10 },
                                align: 'center',
                                anchor: 'center',
                                clamp: true
                            }
                        },
                        scales: {
                            x: { stacked: true, grid: { display: false } },
                            y: {
                                stacked: true,
                                grid: { color: 'rgba(148, 163, 184, 0.1)' },
                                ticks: { callback: v => Math.round(v).toLocaleString() },
                                title: { display: true, text: 'EPC lodgements (count)', color: '#94a3b8' }
                            }
                        }
                    }
                });
            } catch (err) {
                canvas.style.display = 'none';
                fallback.style.display = 'block';
                fallback.innerHTML = `
                    <p><strong>Lodgement chart unavailable.</strong> ${err.message}</p>
                    <p>
                        Re-run the pipeline to regenerate <code>data/outputs/one_stop_output.json</code> (the lodgements-by-year table is embedded in the JSON),
                        or open the latest static chart:
                        <a href="data/outputs/figures/epc_lodgement_year_band_stacked_counts.png" target="_blank" rel="noopener">PNG</a>
                        (or <a href="HeatStreet/data/outputs/figures/epc_lodgement_year_band_stacked_counts.png" target="_blank" rel="noopener">alt path</a>).
                    </p>
                `;
            }
        }

        function buildSubsidyDataFromOneStop(oneStop) {
            const tables = oneStop?.sections?.section_9?.tables || [];
            const table = tables.find(t => (t.caption || '').toLowerCase().includes('subsidy sensitivity'));
            const rows = table?.data || [];
            if (!rows.length) return { byScenario: {}, scenarios: [] };

            const toNum = (value) => {
                const n = Number(value);
                return Number.isFinite(n) ? n : null;
            };

            const clean = rows
                .map(r => ({
                    scenario: String(r.scenario ?? r.scenario_id ?? 'unknown'),
                    scenarioLabel: String(r.scenario_label ?? r.scenarioLabel ?? r.scenario ?? r.scenario_id ?? 'Scenario'),
                    subsidyPct: toNum(r.subsidy_percentage ?? r.subsidy_pct ?? r.subsidy_level_pct),
                    uptakeRate: toNum(r.estimated_uptake_rate ?? r.uptake_rate ?? r.uptake_rate_pct),
                    paybackYears: toNum(r.payback_years ?? r.payback ?? r.payback_period_years),
                    propertiesUpgraded: toNum(r.properties_upgraded ?? r.upgraded_properties),
                    publicSpend: toNum(r.public_expenditure_total ?? r.total_public_expenditure),
                    carbonCost: toNum(r.carbon_abatement_cost_per_tonne ?? r.carbon_abatement_cost),
                    netCostPerProperty: toNum(
                        r.capital_cost_per_property_after_subsidy
                        ?? r.capital_cost_per_property
                        ?? r.cost_per_property_after_subsidy
                    )
                }))
                .filter(r => Number.isFinite(r.subsidyPct));

            const byScenario = {};
            clean.forEach(row => {
                if (!byScenario[row.scenario]) {
                    byScenario[row.scenario] = { label: row.scenarioLabel, rows: [] };
                }
                byScenario[row.scenario].rows.push(row);
            });

            Object.values(byScenario).forEach(s => s.rows.sort((a, b) => a.subsidyPct - b.subsidyPct));

            const preferredOrder = ['heat_pump', 'hybrid', 'heat_network'];
            const scenarioIds = Object.keys(byScenario);
            const ordered = [
                ...preferredOrder.filter(id => scenarioIds.includes(id)),
                ...scenarioIds.filter(id => !preferredOrder.includes(id)).sort()
            ];

            const scenarios = ordered.map(id => ({ id, label: byScenario[id].label || id }));
            return { byScenario, scenarios };
        }

        function destroySubsidyCharts() {
            const keys = [
                'subsidyNetCostChart',
                'subsidyPaybackChart',
                'subsidyUptakeChart',
                'subsidyPropertiesChart',
                'subsidySpendChart',
                'subsidyCarbonChart'
            ];
            keys.forEach(k => {
                if (STATE.charts[k]) {
                    try { STATE.charts[k].destroy(); } catch (_) {}
                    delete STATE.charts[k];
                }
            });
        }

        function renderSubsidyChartsForScenario(scenarioId) {
            const scenario = STATE.subsidy.byScenario?.[scenarioId];
            if (!scenario || !Array.isArray(scenario.rows) || !scenario.rows.length) return;

            destroySubsidyCharts();

            const xs = scenario.rows.map(r => r.subsidyPct);
            const netCost = scenario.rows.map(r => r.netCostPerProperty);
            const payback = scenario.rows.map(r => r.paybackYears);
            const uptakePct = scenario.rows.map(r => Number.isFinite(r.uptakeRate) ? r.uptakeRate * 100 : null);
            const upgraded = scenario.rows.map(r => r.propertiesUpgraded);
            const spendM = scenario.rows.map(r => Number.isFinite(r.publicSpend) ? r.publicSpend / 1e6 : null);
            const carbonCost = scenario.rows.map(r => r.carbonCost);

            const lineBase = {
                type: 'line',
                data: {
                    labels: xs,
                    datasets: [{
                        label: scenario.label || scenarioId,
                        data: [],
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.15)',
                        tension: 0.25,
                        pointRadius: 3,
                        pointHoverRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: tooltipStyle
                    },
                    scales: {
                        x: {
                            grid: { display: false },
                            title: { display: true, text: 'Subsidy level (%)', color: '#94a3b8' }
                        },
                        y: {
                            grid: { color: 'rgba(148, 163, 184, 0.1)' }
                        }
                    }
                }
            };

            // Net cost
            {
                const cfg = JSON.parse(JSON.stringify(lineBase));
                cfg.data.datasets[0].data = netCost;
                cfg.options.plugins.tooltip = {
                    ...tooltipStyle,
                    callbacks: { label: ctx => `Cost/property (after): ${formatGbp(ctx.raw, 0)}` }
                };
                cfg.options.scales.y.ticks = { callback: v => formatGbp(v, 0) };
                STATE.charts.subsidyNetCostChart = new Chart(document.getElementById('subsidyNetCostChart'), cfg);
            }

            // Payback
            {
                const cfg = JSON.parse(JSON.stringify(lineBase));
                cfg.data.datasets[0].data = payback;
                cfg.data.datasets[0].borderColor = '#f97316';
                cfg.data.datasets[0].backgroundColor = 'rgba(249, 115, 22, 0.15)';
                cfg.options.plugins.tooltip = {
                    ...tooltipStyle,
                    callbacks: { label: ctx => `Payback: ${formatYears(ctx.raw)}` }
                };
                cfg.options.scales.y.ticks = { callback: v => Math.round(v).toLocaleString() };
                cfg.options.scales.y.title = { display: true, text: 'Years', color: '#94a3b8' };
                STATE.charts.subsidyPaybackChart = new Chart(document.getElementById('subsidyPaybackChart'), cfg);
            }

            // Uptake
            {
                const cfg = JSON.parse(JSON.stringify(lineBase));
                cfg.data.datasets[0].data = uptakePct;
                cfg.data.datasets[0].borderColor = '#22c55e';
                cfg.data.datasets[0].backgroundColor = 'rgba(34, 197, 94, 0.15)';
                cfg.options.plugins.tooltip = {
                    ...tooltipStyle,
                    callbacks: { label: ctx => `Uptake: ${formatPercent(ctx.raw, 1)}` }
                };
                cfg.options.scales.y.min = 0;
                cfg.options.scales.y.max = 100;
                cfg.options.scales.y.ticks = { callback: v => `${Math.round(v)}%` };
                cfg.options.scales.y.title = { display: true, text: 'Uptake (%)', color: '#94a3b8' };
                STATE.charts.subsidyUptakeChart = new Chart(document.getElementById('subsidyUptakeChart'), cfg);
            }

            // Properties upgraded
            {
                const cfg = JSON.parse(JSON.stringify(lineBase));
                cfg.data.datasets[0].data = upgraded;
                cfg.data.datasets[0].borderColor = '#a855f7';
                cfg.data.datasets[0].backgroundColor = 'rgba(168, 85, 247, 0.15)';
                cfg.options.plugins.tooltip = {
                    ...tooltipStyle,
                    callbacks: { label: ctx => `Upgraded: ${formatInt(ctx.raw)}` }
                };
                cfg.options.scales.y.ticks = { callback: v => Math.round(v).toLocaleString() };
                cfg.options.scales.y.title = { display: true, text: 'Properties (count)', color: '#94a3b8' };
                STATE.charts.subsidyPropertiesChart = new Chart(document.getElementById('subsidyPropertiesChart'), cfg);
            }

            // Public spend
            {
                const cfg = JSON.parse(JSON.stringify(lineBase));
                cfg.data.datasets[0].data = spendM;
                cfg.data.datasets[0].borderColor = '#eab308';
                cfg.data.datasets[0].backgroundColor = 'rgba(234, 179, 8, 0.18)';
                cfg.options.plugins.tooltip = {
                    ...tooltipStyle,
                    callbacks: {
                        label: ctx => {
                            const raw = ctx.raw;
                            if (raw === null || raw === undefined || Number.isNaN(raw)) return 'Public spend: √¢‚Ç¨‚Äù';
                            return `Public spend: ¬£${Number(raw).toFixed(0)}m`;
                        }
                    }
                };
                cfg.options.scales.y.ticks = { callback: v => `¬£${Math.round(v).toLocaleString()}m` };
                cfg.options.scales.y.title = { display: true, text: '¬£m', color: '#94a3b8' };
                STATE.charts.subsidySpendChart = new Chart(document.getElementById('subsidySpendChart'), cfg);
            }

            // Carbon cost
            {
                const cfg = JSON.parse(JSON.stringify(lineBase));
                cfg.data.datasets[0].data = carbonCost;
                cfg.data.datasets[0].borderColor = '#14b8a6';
                cfg.data.datasets[0].backgroundColor = 'rgba(20, 184, 166, 0.15)';
                cfg.options.plugins.tooltip = {
                    ...tooltipStyle,
                    callbacks: { label: ctx => `¬£/tCO‚ÇÇ: ${formatGbp(ctx.raw, 0)}` }
                };
                cfg.options.scales.y.ticks = { callback: v => formatGbp(v, 0) };
                cfg.options.scales.y.title = { display: true, text: '¬£/tCO‚ÇÇ', color: '#94a3b8' };
                STATE.charts.subsidyCarbonChart = new Chart(document.getElementById('subsidyCarbonChart'), cfg);
            }

            // Table
            try {
                const table = document.getElementById('subsidyTable');
                const body = table?.querySelector('tbody');
                if (!body) return;

                const rowsHtml = scenario.rows.map(r => {
                    const paybackLabel = Number.isFinite(r.paybackYears) ? formatYears(r.paybackYears) : '√¢‚Ç¨‚Äù';
                    const uptakeLabel = Number.isFinite(r.uptakeRate) ? formatPercent(r.uptakeRate * 100, 1) : '√¢‚Ç¨‚Äù';
                    const spendLabel = Number.isFinite(r.publicSpend) ? formatGbpCompact(r.publicSpend) : '√¢‚Ç¨‚Äù';
                    const carbonLabel = Number.isFinite(r.carbonCost) ? formatGbp(r.carbonCost, 0) : '√¢‚Ç¨‚Äù';
                    return `
                        <tr>
                            <td>${Math.round(r.subsidyPct)}%</td>
                            <td>${formatGbp(r.netCostPerProperty, 0)}</td>
                            <td>${paybackLabel}</td>
                            <td>${uptakeLabel}</td>
                            <td>${formatInt(r.propertiesUpgraded)}</td>
                            <td>${spendLabel}</td>
                            <td>${carbonLabel}</td>
                        </tr>
                    `;
                }).join('');

                body.innerHTML = rowsHtml || '<tr><td colspan="7" style="color: var(--text-muted);">No subsidy rows available.</td></tr>';
            } catch (_) {}
        }

        function selectSubsidyScenario(scenarioId) {
            STATE.subsidy.selectedScenario = scenarioId;
            document.querySelectorAll('.subsidy-btn').forEach(b => b.classList.toggle('active', b.dataset.subsidyScenario === scenarioId));
            renderSubsidyChartsForScenario(scenarioId);
        }

        function renderSubsidyTab(oneStop) {
            const buttons = document.getElementById('subsidyScenarioButtons');
            const fallback = document.getElementById('subsidyFallback');
            if (!buttons || !fallback) return;

            const { byScenario, scenarios } = buildSubsidyDataFromOneStop(oneStop);
            STATE.subsidy.byScenario = byScenario;
            STATE.subsidy.scenarioOrder = scenarios.map(s => s.id);

            if (!scenarios.length) {
                buttons.innerHTML = '';
                fallback.style.display = 'block';
                fallback.innerHTML = `
                    <p><strong>Subsidy sensitivity data unavailable.</strong> The one-stop output did not include Section 9 results.</p>
                    <p>Re-run the pipeline to regenerate <code>data/outputs/one_stop_output.json</code> with subsidy sensitivity enabled.</p>
                `;
                return;
            }

            fallback.style.display = 'none';
            fallback.innerHTML = '';

            buttons.innerHTML = scenarios.map((s, idx) => `
                <button class="subsidy-btn ${idx === 0 ? 'active' : ''}" type="button" data-subsidy-scenario="${s.id}">
                    ${s.label}
                </button>
            `).join('');

            buttons.querySelectorAll('.subsidy-btn').forEach(btn => {
                btn.addEventListener('click', () => selectSubsidyScenario(btn.dataset.subsidyScenario));
            });

            const preferred = STATE.subsidy.selectedScenario && byScenario[STATE.subsidy.selectedScenario]
                ? STATE.subsidy.selectedScenario
                : (byScenario.heat_pump ? 'heat_pump' : scenarios[0].id);
            selectSubsidyScenario(preferred);
        }

        function buildScenarioDataFromOneStop(oneStop) {
            const rows = oneStop?.sections?.section_6?.tables?.[0]?.data || [];
            const shortLabels = {
                fabric_only: 'Fabric Only',
                fabric_to_tipping_point: 'Fabric Tipping',
                minimum_fabric_hp_ready: 'Min Fabric+HP',
                heat_pump: 'Heat Pump',
                heat_network: 'Heat Network',
                hybrid: 'Hybrid'
            };

            const out = {};
            rows
                .filter(r => r?.scenario_id && r.scenario_id !== 'baseline')
                .forEach(r => {
                    const paybackYears = r.average_payback_years ?? null;
                    out[r.scenario_id] = {
                        name: r.scenario || r.scenario_id,
                        shortLabel: shortLabels[r.scenario_id] || r.scenario_id,

                        capitalCostTotalValue: r.capital_cost_total ?? null,
                        capitalCostPerPropertyValue: r.capital_cost_per_property ?? null,
                        annualCo2ReductionKgValue: r.annual_co2_reduction_kg ?? null,
                        annualBillSavingsValue: r.annual_bill_savings ?? null,
                        paybackYearsValue: paybackYears,

                        capitalTotal: formatGbpCompact(r.capital_cost_total),
                        capitalPer: formatGbp(r.capital_cost_per_property, 0) + '/property',
                        co2: formatMtFromKg(r.annual_co2_reduction_kg),
                        bills: formatGbpCompact(r.annual_bill_savings),
                        payback: formatYears(paybackYears),
                        epcBefore: r.band_c_or_better_before_pct ?? null,
                        epcAfter: r.band_c_or_better_after_pct ?? null
                    };
                });

            return out;
        }

        function formatMaybePercent(v, decimals = 1) {
            if (typeof v === 'string' && v.trim().endsWith('%')) return v.trim();
            return formatPercent(v, decimals);
        }

        function renderHeatNetworkTierTable(oneStop) {
            const tbody = document.querySelector('#readiness .data-table tbody');
            const rows = oneStop?.sections?.section_5?.tables?.[0]?.data || [];
            tbody.innerHTML = '';

            if (!rows.length) {
                tbody.innerHTML = '<tr><td colspan=\"4\" style=\"color: var(--text-muted);\">No heat network tier table found in one-stop output.</td></tr>';
                return;
            }

            rows.forEach(r => {
                const tierLabel = r['Tier'] || r['tier'] || '‚Äî';
                const count = r['Property Count'] ?? r['property_count'];
                const share = r['Percentage'] ?? r['percentage'];
                const pathway = r['Recommended Pathway'] || r['recommended_pathway'] || '‚Äî';
                const badgeClass = /district/i.test(pathway) ? 'green' : 'blue';

                const tr = document.createElement('tr');
                tr.innerHTML = `\n                    <td>${tierLabel}</td>\n                    <td>${formatInt(count)}</td>\n                    <td>${formatMaybePercent(share, 1)}</td>\n                    <td><span class=\"badge ${badgeClass}\">${pathway}</span></td>\n                `;
                tbody.appendChild(tr);
            });
        }

        function renderScenarioTable() {
            const tbody = document.querySelector('#scenarioTable tbody');
            tbody.innerHTML = '';

            const order = [
                'fabric_only',
                'fabric_to_tipping_point',
                'minimum_fabric_hp_ready',
                'heat_pump',
                'heat_network',
                'hybrid'
            ];

            order.forEach(id => {
                const s = scenarioData[id];
                if (!s) return;

                const tr = document.createElement('tr');
                tr.dataset.row = id;
                if (id === 'hybrid') tr.classList.add('selected');

                tr.innerHTML = `\n                    <td>${s.shortLabel}</td>\n                    <td>${formatGbpCompact(s.capitalCostTotalValue)}</td>\n                    <td>${formatGbp(s.capitalCostPerPropertyValue, 0)}</td>\n                    <td class=\"text-green\">${formatMtFromKg(s.annualCo2ReductionKgValue)}</td>\n                    <td class=\"text-orange\">${formatGbpCompact(s.annualBillSavingsValue)}</td>\n                    <td class=\"text-purple\">${Math.round(Number(s.paybackYearsValue || 0))} yrs</td>\n                `;
                tbody.appendChild(tr);
            });
        }

        function selectScenario(scenarioId) {
            const data = scenarioData[scenarioId];
            if (!data) return;

            document.querySelectorAll('.scenario-btn').forEach(b => b.classList.toggle('active', b.dataset.scenario === scenarioId));

            document.querySelectorAll('#scenarioTable tbody tr').forEach(row => {
                row.classList.toggle('selected', row.dataset.row === scenarioId);
            });

            document.getElementById('scenarioTitle').textContent = data.name;
            document.getElementById('metricCapital').textContent = data.capitalTotal;
            document.getElementById('metricCapitalPer').textContent = data.capitalPer;
            document.getElementById('metricCO2').textContent = data.co2;
            document.getElementById('metricBills').textContent = data.bills;
            document.getElementById('metricPayback').textContent = data.payback;

            document.getElementById('epcBefore').textContent = formatPercent(data.epcBefore, 1);
            document.getElementById('epcAfter').textContent = formatPercent(data.epcAfter, 1);
            document.getElementById('epcBarBefore').style.width = `${Math.max(0, Math.min(100, Number(data.epcBefore || 0)))}%`;
            document.getElementById('epcBarAfter').style.width = `${Math.max(0, Math.min(100, Number(data.epcAfter || 0)))}%`;
        }

        function renderDashboard(oneStop) {
            STATE.oneStop = oneStop;
            STATE.source = oneStop.__source || 'one_stop_output.json';

            const meta = oneStop.metadata || {};
            const generated = meta.generated ? new Date(meta.generated) : null;
            document.getElementById('analysisDate').textContent = generated
                ? generated.toLocaleDateString(undefined, { year: 'numeric', month: 'long', day: 'numeric' })
                : '‚Äî';
            document.getElementById('dataSource').textContent = STATE.source;

            const sec2 = getDatapointMap(oneStop.sections?.section_2);
            const sec3 = getDatapointMap(oneStop.sections?.section_3);
            const sec4 = getDatapointMap(oneStop.sections?.section_4);

            const totalProps = sec2.records_passing_validation ?? sec4.readiness_total_properties ?? null;
            document.getElementById('kpiProperties').textContent = formatInt(totalProps);
            document.getElementById('footerPropertiesCount').textContent = formatInt(totalProps);

            const heating = sec3.heating_system_distribution || {};
            const heatTotal = Object.values(heating).reduce((a, b) => a + (Number(b) || 0), 0);
            const gasPct = heatTotal ? 100 * (heating['Gas Boiler'] || 0) / heatTotal : null;
            const hpPct = heatTotal ? 100 * (heating['Heat Pump'] || 0) / heatTotal : null;
            document.getElementById('kpiGasPct').textContent = formatPercent(gasPct, 1);
            document.getElementById('insightHeatPumps').textContent = formatPercent(hpPct, 1);

            const hpReadyPct = (Number(sec4.tier_1_pct) || 0) + (Number(sec4.tier_2_pct) || 0);
            document.getElementById('kpiHpReadyPct').textContent = formatPercent(hpReadyPct, 1);
            document.getElementById('kpiSapMean').textContent = sec3.sap_score_mean ? Number(sec3.sap_score_mean).toFixed(1) : '‚Äî';

            const epcPct = sec3.epc_band_percentages || {};
            const belowEpcC = 100 - ((epcPct.A || 0) + (epcPct.B || 0) + (epcPct.C || 0));
            document.getElementById('insightBelowEpcC').textContent = formatPercent(belowEpcC, 1);
            document.getElementById('insightWallInsulation').textContent = formatPercent(sec3.wall_insulation_rate_pct, 1);

            const glazing = sec3.glazing_distribution || {};
            const glazingTotal = Object.values(glazing).reduce((a, b) => a + (Number(b) || 0), 0);
            const glazingPct = key => (glazingTotal ? 100 * (glazing[key] || 0) / glazingTotal : null);

            document.getElementById('insightDoubleGlazing').textContent = formatPercent(glazingPct('Double'), 1);

            document.getElementById('glazingDoublePct').textContent = formatPercent(glazingPct('Double'), 1);
            document.getElementById('glazingDoubleCount').textContent = formatInt(glazing.Double) + ' properties';
            document.getElementById('glazingUnknownPct').textContent = formatPercent(glazingPct('Unknown'), 1);
            document.getElementById('glazingUnknownCount').textContent = formatInt(glazing.Unknown) + ' properties';
            document.getElementById('glazingSinglePct').textContent = formatPercent(glazingPct('Single'), 1);
            document.getElementById('glazingSingleCount').textContent = formatInt(glazing.Single) + ' properties';
            document.getElementById('glazingTriplePct').textContent = formatPercent(glazingPct('Triple'), 1);
            document.getElementById('glazingTripleCount').textContent = formatInt(glazing.Triple) + ' properties';

            document.getElementById('hpTier1Pct').textContent = formatPercent(sec4.tier_1_pct, 1);
            document.getElementById('hpTier1Count').textContent = formatInt(sec4.tier_1_count) + ' properties';
            document.getElementById('hpTier2Pct').textContent = formatPercent(sec4.tier_2_pct, 1);
            document.getElementById('hpTier2Count').textContent = formatInt(sec4.tier_2_count) + ' properties';
            document.getElementById('hpTier3Pct').textContent = formatPercent(sec4.tier_3_pct, 1);
            document.getElementById('hpTier3Count').textContent = formatInt(sec4.tier_3_count) + ' properties';
            document.getElementById('hpTier4Pct').textContent = formatPercent(sec4.tier_4_pct, 1);
            document.getElementById('hpTier4Count').textContent = formatInt(sec4.tier_4_count) + ' properties';
            document.getElementById('hpTier5Pct').textContent = formatPercent(sec4.tier_5_pct, 1);
            document.getElementById('hpTier5Count').textContent = formatInt(sec4.tier_5_count) + ' properties';

            scenarioData = buildScenarioDataFromOneStop(oneStop);
            renderScenarioTable();
            renderHeatNetworkTierTable(oneStop);

            const epcDist = sec3.epc_band_distribution || {};
            const epcLabels = ['A', 'B', 'C', 'D', 'E', 'F', 'G'];
            const epcCounts = epcLabels.map(l => epcDist[l] || 0);

            const scenarioOrder = [
                'fabric_only',
                'fabric_to_tipping_point',
                'minimum_fabric_hp_ready',
                'heat_pump',
                'heat_network',
                'hybrid'
            ];
            const scenarioLabels = scenarioOrder.map(id => scenarioData[id]).filter(Boolean).map(s => s.shortLabel);
            const scenarioCostK = scenarioOrder.map(id => scenarioData[id]).filter(Boolean).map(s => Number(s.capitalCostPerPropertyValue || 0) / 1000);
            const scenarioCo2Mt = scenarioOrder.map(id => scenarioData[id]).filter(Boolean).map(s => Number(s.annualCo2ReductionKgValue || 0) / 1e9);

            const wallDist = sec3.wall_type_distribution || {};
            const wallLabelMap = {
                solid_brick: 'Solid Brick',
                cavity: 'Cavity',
                other: 'Other',
                timber_frame: 'Timber Frame',
                system_built: 'System Built',
                stone: 'Stone'
            };
            const wallKeys = Object.keys(wallLabelMap);
            const wallLabels = wallKeys.map(k => wallLabelMap[k]);
            const wallCounts = wallKeys.map(k => wallDist[k] || 0);

            const heatingLabels = ['Gas Boiler', 'Electric', 'Other', 'Heat Network', 'Heat Pump'];
            const heatingCounts = [
                heating['Gas Boiler'] || 0,
                heating['Electric'] || 0,
                heating['Other'] || 0,
                heating['District/Communal/Heat Network'] || 0,
                heating['Heat Pump'] || 0
            ];

            const loftDist = sec3.loft_status_distribution || {};
            const loftOrder = [
                { key: 'Partial (100-200mm)', label: 'Partial (100-200mm)' },
                { key: 'None', label: 'None' },
                { key: 'Good (200-269mm)', label: 'Good (200-269mm)' },
                { key: 'Good/Very Good (efficiency rating)', label: 'Good/Very Good' },
                { key: 'Full (‚â•270mm)', label: 'Full (‚â•270mm)' },
                { key: 'Low (<100mm)', label: 'Low (<100mm)' },
                { key: 'Average (efficiency rating)', label: 'Average' },
                { key: 'Very Poor (efficiency rating)', label: 'Very Poor' },
                { key: 'Poor (efficiency rating)', label: 'Poor' },
                { key: 'Unknown', label: 'Unknown' }
            ];
            const loftLabels = loftOrder.map(o => o.label);
            const loftCounts = loftOrder.map(o => loftDist[o.key] || 0);

            const readinessCounts = [
                sec4.tier_1_count || 0,
                sec4.tier_2_count || 0,
                sec4.tier_3_count || 0,
                sec4.tier_4_count || 0,
                sec4.tier_5_count || 0
            ];

            renderCharts({
                epcCounts,
                scenarioLabels,
                scenarioCostK,
                scenarioCo2Mt,
                wallLabels,
                wallCounts,
                heatingLabels,
                heatingCounts,
                loftLabels,
                loftCounts,
                readinessCounts
            });

            renderTippingPointChart(oneStop);
            renderLodgementYearBandChart(oneStop);
            renderSubsidyTab(oneStop);
            selectScenario('hybrid');
        }

        // Tab Navigation
        document.querySelectorAll('.nav-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                document.getElementById(this.dataset.tab).classList.add('active');

                // Charts created in hidden tabs can render at 0px; resize after the tab becomes visible.
                requestAnimationFrame(() => {
                    Object.values(STATE.charts).forEach(ch => { try { ch.resize(); } catch (_) {} });
                });
            });
        });

        // Scenario Selection
        document.querySelectorAll('.scenario-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                selectScenario(this.dataset.scenario);
            });
        });

        // Data loading and file picker fallback
        const jsonPicker = document.createElement('input');
        jsonPicker.type = 'file';
        jsonPicker.accept = 'application/json';
        jsonPicker.style.display = 'none';
        document.body.appendChild(jsonPicker);

        document.getElementById('loadJsonBtn').addEventListener('click', () => jsonPicker.click());

        jsonPicker.addEventListener('change', async (e) => {
            const file = e.target.files?.[0];
            if (!file) return;
            try {
                const text = await file.text();
                const data = JSON.parse(text);
                data.__source = file.name;
                setDataStatus();
                renderDashboard(data);
            } catch (err) {
                setDataStatus({ message: `Could not parse JSON: ${err.message}`, error: true });
            } finally {
                jsonPicker.value = '';
            }
        });

        (async () => {
            setDataStatus({ message: 'Loading latest one-stop output‚Ä¶' });
            try {
                const data = await loadOneStopData();
                setDataStatus();
                renderDashboard(data);
            } catch (err) {
                setDataStatus({ message: err.message, error: true });
            }
        })();
    </script>
</body>
</html>
